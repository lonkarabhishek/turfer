<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapTurf Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .schema-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .danger-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .primary-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <i data-lucide="shield-check" class="mx-auto h-16 w-16 text-blue-600 mb-4"></i>
                <h1 class="text-2xl font-bold text-gray-800">TapTurf Admin Portal</h1>
                <p class="text-gray-600 mt-2">Secure access required</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                           placeholder="Enter admin username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                           placeholder="Enter admin password">
                </div>
                
                <div id="loginError" class="text-red-600 text-sm hidden"></div>
                
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg hover:from-blue-700 hover:to-indigo-700 transition-all duration-200 font-medium">
                    <i data-lucide="log-in" class="inline mr-2 h-5 w-5"></i>
                    Access Admin Panel
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    <i data-lucide="lock" class="inline h-3 w-3 mr-1"></i>
                    Authorized personnel only
                </p>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="hidden">
        <div class="container mx-auto px-4 py-6 max-w-7xl">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                            <i data-lucide="database" class="mr-3 text-blue-600"></i>
                            TapTurf Admin Portal
                        </h1>
                        <p class="text-gray-600 mt-2">Database & Environment Management</p>
                    </div>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i data-lucide="log-out" class="inline mr-2 h-4 w-4"></i>
                        Logout
                    </button>
                </div>
                <div id="connectionStatus" class="mt-4"></div>
            </div>

            <!-- Environment Selector -->
            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Environment</h2>
                    <div class="flex items-center space-x-4">
                        <select onchange="switchEnvironment(this.value)" id="environmentSelector" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-40 p-2.5">
                            <option value="development">Development</option>
                            <option value="staging">Staging</option>
                            <option value="production">Production</option>
                        </select>
                    </div>
                </div>
                <p class="text-gray-600 text-sm mb-4">
                    Currently viewing: <span id="currentEnvironment" class="font-semibold text-blue-600">Development Environment</span>
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="font-semibold text-blue-800">Development</div>
                        <div class="text-blue-600">SQLite • dev.sqlite</div>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <div class="font-semibold text-yellow-800">Staging</div>
                        <div class="text-yellow-600">SQLite • staging.sqlite</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="font-semibold text-green-800">Production</div>
                        <div class="text-green-600">PostgreSQL • Railway</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-lg mb-6 p-6">
                <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onclick="openApp()" class="primary-btn text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                        <i data-lucide="external-link" class="inline mr-2"></i>Open Live App
                    </button>
                    <button onclick="openDatabaseAdmin()" class="export-btn text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all">
                        <i data-lucide="database" class="inline mr-2"></i>Database Admin
                    </button>
                    <button onclick="openProductionApp()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-all">
                        <i data-lucide="globe" class="inline mr-2"></i>Production App
                    </button>
                    <button onclick="refreshData()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-all">
                        <i data-lucide="refresh-cw" class="inline mr-2"></i>Refresh Data
                    </button>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="showTab('overview')" class="tab-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-semibold">
                            <i data-lucide="bar-chart-3" class="inline mr-2"></i>Overview
                        </button>
                        <button onclick="showTab('users')" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i data-lucide="users" class="inline mr-2"></i>Users
                        </button>
                        <button onclick="showTab('turfs')" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i data-lucide="map-pin" class="inline mr-2"></i>Turfs
                        </button>
                        <button onclick="showTab('games')" class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i data-lucide="gamepad-2" class="inline mr-2"></i>Games
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Total Users</p>
                                <p class="text-3xl font-bold" id="totalUsers">-</p>
                            </div>
                            <i data-lucide="users" class="text-4xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100">Total Turfs</p>
                                <p class="text-3xl font-bold" id="totalTurfs">-</p>
                            </div>
                            <i data-lucide="map-pin" class="text-4xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 rounded-xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100">Active Games</p>
                                <p class="text-3xl font-bold" id="activeGames">-</p>
                            </div>
                            <i data-lucide="gamepad-2" class="text-4xl text-purple-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-6 rounded-xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100">Backend Status</p>
                                <p class="text-2xl font-bold" id="backendStatus">Checking...</p>
                            </div>
                            <i data-lucide="server" class="text-4xl text-orange-200"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Tables (Users, Turfs, Games) -->
            <div id="users" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Users Management</h2>
                        <div class="space-x-2">
                            <button onclick="loadTableData('users')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                <i data-lucide="refresh-cw" class="inline mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div id="usersTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-8">Click refresh to load users data</p>
                    </div>
                </div>
            </div>

            <div id="turfs" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Turfs Management</h2>
                        <div class="space-x-2">
                            <button onclick="loadTableData('turfs')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                <i data-lucide="refresh-cw" class="inline mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div id="turfsTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-8">Click refresh to load turfs data</p>
                    </div>
                </div>
            </div>

            <div id="games" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Games Management</h2>
                        <div class="space-x-2">
                            <button onclick="loadTableData('games')" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                                <i data-lucide="refresh-cw" class="inline mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div id="gamesTable" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-8">Click refresh to load games data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Admin Credentials
        const ADMIN_CREDENTIALS = {
            username: 'turfmaster',
            password: 'SportHub@2024!'
        };

        // Configuration
        const LOCAL_API_BASE = 'http://localhost:3001/api';
        const STAGING_API_BASE = 'http://localhost:3001/api';
        const PRODUCTION_API_BASE = 'https://turfer-backend-production.up.railway.app/api';
        const APP_URL = 'https://turfer.vercel.app';
        const DB_ADMIN_URL = 'http://localhost:3004';
        
        let currentTab = 'overview';
        let currentEnvironment = 'production'; // Default to production for live admin
        let API_BASE = PRODUCTION_API_BASE;
        let isAuthenticated = false;

        // Authentication Functions
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                isAuthenticated = true;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                
                // Store auth in session
                sessionStorage.setItem('turfAdminAuth', 'true');
                
                // Initialize admin panel
                lucide.createIcons();
                checkConnection();
                loadOverviewData();
            } else {
                errorDiv.textContent = 'Invalid credentials. Access denied.';
                errorDiv.classList.remove('hidden');
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        }

        function logout() {
            isAuthenticated = false;
            sessionStorage.removeItem('turfAdminAuth');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        function checkAuth() {
            const storedAuth = sessionStorage.getItem('turfAdminAuth');
            if (storedAuth === 'true') {
                isAuthenticated = true;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                return true;
            }
            return false;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            
            // Set production as default
            document.getElementById('environmentSelector').value = 'production';
            switchEnvironment('production');
            
            // Check if already authenticated
            if (checkAuth()) {
                checkConnection();
                loadOverviewData();
            }
        });

        // Switch between environments
        function switchEnvironment(env) {
            currentEnvironment = env;
            const environmentSpan = document.getElementById('currentEnvironment');
            
            switch(env) {
                case 'development':
                    API_BASE = LOCAL_API_BASE;
                    environmentSpan.textContent = 'Development Environment';
                    environmentSpan.className = 'font-semibold text-blue-600';
                    break;
                case 'staging':
                    API_BASE = STAGING_API_BASE;
                    environmentSpan.textContent = 'Staging Environment';
                    environmentSpan.className = 'font-semibold text-yellow-600';
                    break;
                case 'production':
                    API_BASE = PRODUCTION_API_BASE;
                    environmentSpan.textContent = 'Production Environment';
                    environmentSpan.className = 'font-semibold text-green-600';
                    break;
            }
            
            // Refresh data with new environment
            if (isAuthenticated) {
                checkConnection();
                loadOverviewData();
                if (currentTab !== 'overview') {
                    loadTableData(currentTab);
                }
            }
        }

        // Quick Actions
        function openApp() {
            window.open(APP_URL, '_blank');
        }

        function openDatabaseAdmin() {
            alert('Database admin available in local environment only');
        }

        function openProductionApp() {
            window.open('https://turfer.vercel.app', '_blank');
        }

        function refreshData() {
            if (isAuthenticated) {
                loadOverviewData();
                if (currentTab !== 'overview') {
                    loadTableData(currentTab);
                }
            }
        }

        // Tab Management
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            event.target.classList.add('border-blue-500', 'text-blue-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');

            currentTab = tabName;

            // Load data for specific tabs
            if (tabName !== 'overview' && isAuthenticated) {
                loadTableData(tabName);
            }
        }

        // Connection Check
        async function checkConnection() {
            if (!isAuthenticated) return;
            
            try {
                const healthUrl = currentEnvironment === 'production'
                    ? 'https://turfer-backend-production.up.railway.app/health'
                    : 'http://localhost:3001/health';
                    
                const response = await fetch(healthUrl);
                const data = await response.json();
                const sourceType = currentEnvironment.charAt(0).toUpperCase() + currentEnvironment.slice(1);
                
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="flex items-center text-green-600 bg-green-50 px-4 py-2 rounded-lg">
                        <i data-lucide="check-circle" class="mr-2"></i>
                        Connected to ${sourceType} Backend (${data.environment || currentEnvironment})
                    </div>
                `;
                document.getElementById('backendStatus').textContent = '✅ Running';
            } catch (error) {
                const sourceType = currentEnvironment.charAt(0).toUpperCase() + currentEnvironment.slice(1);
                document.getElementById('connectionStatus').innerHTML = `
                    <div class="flex items-center text-red-600 bg-red-50 px-4 py-2 rounded-lg">
                        <i data-lucide="x-circle" class="mr-2"></i>
                        ${sourceType} Connection Failed: ${error.message}
                    </div>
                `;
                document.getElementById('backendStatus').textContent = '❌ Down';
            }
            lucide.createIcons();
        }

        // Load Overview Data
        async function loadOverviewData() {
            if (!isAuthenticated) return;
            
            try {
                // Get turfs count
                const turfsResponse = await fetch(`${API_BASE}/turfs`);
                const turfsData = await turfsResponse.json();
                document.getElementById('totalTurfs').textContent = turfsData.data?.turfs?.length || turfsData.data?.length || 0;

                // Get games count with error handling
                try {
                    const gamesResponse = await fetch(`${API_BASE}/games`);
                    const gamesData = await gamesResponse.json();
                    if (gamesData.success) {
                        const activeGamesCount = gamesData.data?.filter(g => g.status === 'open')?.length || 0;
                        document.getElementById('activeGames').textContent = activeGamesCount;
                    } else {
                        document.getElementById('activeGames').textContent = 'Error';
                    }
                } catch (gameError) {
                    document.getElementById('activeGames').textContent = 'N/A';
                }

                // Set users based on environment
                if (currentEnvironment === 'production') {
                    document.getElementById('totalUsers').textContent = '~100+';
                } else {
                    document.getElementById('totalUsers').textContent = '~5+';
                }

            } catch (error) {
                console.error('Error loading overview data:', error);
                document.getElementById('totalTurfs').textContent = 'Error';
                document.getElementById('activeGames').textContent = 'Error';
                document.getElementById('totalUsers').textContent = 'Error';
            }
        }

        // Load Table Data
        async function loadTableData(tableName) {
            if (!isAuthenticated) return;
            
            try {
                let response;
                if (tableName === 'turfs') {
                    response = await fetch(`${API_BASE}/turfs`);
                    const data = await response.json();
                    const tableData = data.data?.turfs || data.data || [];
                    renderTable(tableName, tableData);
                    
                } else if (tableName === 'games') {
                    response = await fetch(`${API_BASE}/games`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        document.getElementById(`${tableName}Table`).innerHTML = `
                            <div class="text-center py-8 text-yellow-600">
                                <i data-lucide="alert-triangle" class="mx-auto mb-4 text-4xl"></i>
                                <p>Games API Error: ${data.error || 'Internal server error'}</p>
                                <p class="text-sm text-gray-500 mt-2">This endpoint may not be implemented yet in production.</p>
                            </div>
                        `;
                        lucide.createIcons();
                        return;
                    }
                    
                    const tableData = data.data || [];
                    renderTable(tableName, tableData);
                    
                } else {
                    document.getElementById(`${tableName}Table`).innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i data-lucide="info" class="mx-auto mb-4 text-4xl"></i>
                            <p>Users data requires backend authentication.</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

            } catch (error) {
                console.error(`Error loading ${tableName} data:`, error);
                document.getElementById(`${tableName}Table`).innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i data-lucide="alert-circle" class="mx-auto mb-4 text-4xl"></i>
                        <p>Error loading data: ${error.message}</p>
                        <p class="text-sm text-gray-500 mt-2">Check your network connection and API availability.</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        // Render Table
        function renderTable(tableName, data) {
            if (!data || data.length === 0) {
                document.getElementById(`${tableName}Table`).innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="database" class="mx-auto mb-4 text-4xl"></i>
                        <p>No ${tableName} found</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const headers = Object.keys(data[0]);
            const tableHtml = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            ${headers.map(header => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${data.map(row => `
                            <tr class="hover:bg-gray-50">
                                ${headers.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCellValue(row[header])}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById(`${tableName}Table`).innerHTML = tableHtml;
        }

        // Format cell values
        function formatCellValue(value) {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'object') return JSON.stringify(value).substring(0, 50) + '...';
            if (typeof value === 'string' && value.length > 50) return value.substring(0, 50) + '...';
            return value;
        }
    </script>
</body>
</html>